USE [CDP]
GO

CREATE TRIGGER trg_UpdateSendUuidSort
ON [dbo].[Workflow]
AFTER INSERT
AS
BEGIN
    DECLARE @SendUuid NVARCHAR(50);

    -- 取得插入資料的 SendUuid
    SELECT @SendUuid = SendUuid FROM inserted;

    -- 依照 CreateAt 時間排序，將結果更新到 SendUuidSort 欄位
    WITH Ranked AS (
        SELECT SN, ROW_NUMBER() OVER (PARTITION BY SendUuid ORDER BY CreateAt) AS RowNum
        FROM [dbo].[Workflow]
        WHERE SendUuid = @SendUuid
    )
    UPDATE w
    SET w.SendUuidSort = r.RowNum
    FROM [dbo].[Workflow] w
    JOIN Ranked r ON w.SN = r.SN;
END
GO
